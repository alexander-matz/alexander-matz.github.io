Copyright (c) 2016, Alexander Matz
All rights reserved.

Redistribution and use in source and binary forms, with or without modification,
are permitted provided that the following conditions are met:

1. Redistributions of source code must retain the above copyright notice, this
   list of conditions and the following disclaimer.

2. Redistributions in binary form must reproduce the above copyright notice,
   this list of conditions and the following disclaimer in the documentation
   and/or other materials provided with the distribution.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR
ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
"use strict";function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++)arr2[i]=arr[i];return arr2}return Array.from(arr)}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_slicedToArray=function(){function sliceIterator(arr,i){var _arr=[],_n=!0,_d=!1,_e=void 0;try{for(var _s,_i=arr[Symbol.iterator]();!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{!_n&&_i.return&&_i.return()}finally{if(_d)throw _e}}return _arr}return function(arr,i){if(Array.isArray(arr))return arr;if(Symbol.iterator in Object(arr))return sliceIterator(arr,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();$(document).ready(function(){tabs.init($("#tabs"),$("#tab-content")),tabs.add({name:"db",text:"Files",onInit:vDb.onInit,onActivate:vDb.onActivate,onBeforeDeactivate:vDb.onBeforeDeactivate,onDeactivate:vDb.onDeactivate}),tabs.add({name:"teams",text:"Teams",onInit:vTeams.onInit,onActivate:vTeams.onActivate,onBeforeDeactivate:vTeams.onBeforeDeactivate,onDeactivate:vTeams.onDeactivate}),tabs.add({name:"rules",text:"Rules",onInit:vRules.onInit,onActivate:vRules.onActivate,onBeforeDeactivate:vRules.onBeforeDeactivate,onDeactivate:vRules.onDeactivate}),tabs.add({name:"match",text:"Matching",onInit:vMatching.onInit,onActivate:vMatching.onActivate,onBeforeDeactivate:vMatching.onBeforeDeactivate,onDeactivate:vMatching.onDeactivate}),tabs.add({name:"map",text:"Map",onInit:vMap.onInit,onActivate:vMap.onActivate,onBeforeDeactivate:vMap.onBeforeDeactivate,onDeactivate:vMap.onDeactivate}),tabs.add({name:"mails",text:"Mails",onInit:vMails.onInit,onActivate:vMails.onActivate,onBeforeDeactivate:vMails.onBeforeDeactivate,onDeactivate:vMails.onDeactivate}),tabs.addSpacer(),vFooter.init($("#footer-row")),vLoading.init($("#loading")),tabs.tryActivate("db"),persistence.load(),sig.on("*-modified",delayedOnce.make(function(){persistence.save()},2))});var utf8=function(){function encode(s){return unescape(encodeURIComponent(s))}function decode(s){return decodeURIComponent(escape(s))}return{encode:encode,decode:decode}}(),stateMachine=function(initial,transitions){for(var states={},i=0;i<transitions.length;++i)for(var _transitions$i=transitions[i],from=_transitions$i.from,to=_transitions$i.to,symbol=_transitions$i.symbol,action=_transitions$i.action,j=0;j<from.length;++j){if(void 0===states[from[j]]&&(states[from[j]]={}),void 0!==states[from[j]][symbol])throw"already added transition for ["+from[j]+"] < "+symbol;states[from[j]][symbol]={to:to,action:action}}var state=initial;return function(symbol,data){if(void 0===symbol&&void 0===data)return state;if(void 0===states[state])throw"in invalid state "+state;if(void 0===states[state][symbol])throw"invalid input: ["+state+"] < "+symbol;states[state][symbol].action(data),state=states[state][symbol].to}},shittySnowflake=function(){function now(){var d=new Date;return d.getTime()}var seq=0;return function(){return seq+=1,(seq=1e4)&&(seq=0),(seq+now()).toString(16)}}(),delayedOnce=function(){function make(fn,timeout){function wrappedFn(){fn.apply(null,args),timeoutHandler=null}var timeoutHandler=null,args=[];return function(){null!==timeoutHandler&&clearTimeout(timeoutHandler),args=arguments,timeoutHandler=setTimeout(wrappedFn,1e3*timeout)}}return{make:make}}(),tooltip=function(){function add(element,text,classes){function windowMouseMove(event){tip.css("left",event.clientX+20+"px"),tip.css("top",event.clientY+"px")}var tip=$('<div style="display: none; position: relative;">'+text+"</div>");void 0===classes&&(classes=[]);for(var i=0;i<classes.length;++i)tip.addClass(classes[i]);$(element).on("mouseenter",function(event){tip.css("display","block"),$(window).on("mousemove",windowMouseMove),windowMouseMove(event)}),$(element).on("mouseleave",function(event){tip.css("display","none"),$(window).off("mousemove",windowMouseMove)}),$("body").append(tip)}return{add:add}}(),sig=function(){function on(name,handler){return name in signals||(signals[name]=[]),signals[name].push(handler),signals[name].length}function off(name,handler){if(name in signals)if(void 0===handler)signals[name]=[];else{var idx=signals[name].indexOf(handler);idx>-1&&signals[name].splice(idx,1)}}function sigmatch(pat,sig){for(var prevIndex=-1,array=pat.split("*"),result=!0,i=0;i<array.length&&result;i++){var index=sig.indexOf(array[i]);if(index==-1||index<prevIndex)return!1}return result}function auxemit(handlers,args){for(var n=0,i=0;i<handlers.length;++i)handlers[i].apply(null,args),n+=1;return n}function emit(){if(arguments.length<1)throw"not enough arguments to 'emit'";for(var name=arguments[0],args=[],i=1;i<arguments.length;++i)args.push(arguments[i]);var n=0;for(var _sig in signals)sigmatch(_sig,name)&&(n+=auxemit(signals[_sig],args));return n}var signals={};return{on:on,off:off,emit:emit}}(),csv=function(){function parseQuoted(line,_pos,quoteChar){var pos=_pos;if(pos>=line.length||line[pos]!==quoteChar)return[!1,pos];pos+=1;for(var start=pos;pos<line.length&&line[pos]!=quoteChar;)pos+=1;var end=pos;return line[pos]!==quoteChar?[!1,_pos]:(pos+=1,[line.substring(start,end),pos])}function newParser(options){if(void 0===options.separator)throw"no separator specified";var sep=options.separator,quote=options.quote;return void 0!==quote?function(line){for(var tokens=[],pos=0;pos<line.length;){var _parseQuoted=parseQuoted(line,pos,quote),_parseQuoted2=_slicedToArray(_parseQuoted,2),token=_parseQuoted2[0],newpos=_parseQuoted2[1];if(token===!1)return["missing/wrong field at pos "+pos,null];if(pos=newpos,pos<line.length){if("\n"!==line[pos]&&"\r"!==line[pos]&&line[pos]!==sep)return["expected separator at pos "+pos];pos+=1}tokens[tokens.length]=token}return[null,tokens]}:function(line){for(var tokens=[],pos=0;pos<line.length;){for(var start=pos;pos<line.length&&line[pos]!==sep;)pos+=1;var end=pos;tokens[tokens.length]=line.substring(start,end),pos<line.length&&(pos+=1)}return[null,tokens]}}function isSkipLine(line){return""===line.trim()}function fromString(raw,options){if(!options.hasHeader&&void 0===options.fields)return["no field specification supplied",null];if(options.hasHeader&&void 0!==options.fields)return["cannot have header and field specification supplied",null];var lineno=0,lines=raw.split("\n"),fields=void 0,parse=void 0,separator=options.separator;if(parse=newParser(void 0!==options.quote?{quote:options.quote,separator:separator}:{separator:separator}),void 0===separator)return["no separator specified",null];for(;isSkipLine(lines[lineno]);)lineno++;if(options.hasHeader){if(lineno>=lines.length)return["line "+lineno+": expected header, got end of input",null];var _parse=parse(lines[lineno]),_parse2=_slicedToArray(_parse,2),err=_parse2[0],tokens=_parse2[1];if(err)return["line "+lineno+": "+err,null];lineno+=1,fields=tokens}else fields=options.fields;if(options.requiredFields){for(var lookup={},i=0;i<fields.length;++i)lookup[fields[i]]=!0;for(var req=options.requiredFields,_i=0;_i<req.length;++_i)if(void 0===lookup[req[_i]])return["missing required field: "+req[_i],null]}for(var rows=[];lineno<lines.length;)if(isSkipLine(lines[lineno]))lineno+=1;else{var _parse3=parse(lines[lineno]),_parse4=_slicedToArray(_parse3,2),_err=_parse4[0],_tokens=_parse4[1];if(_err)return["line "+lineno+": "+_err,null];if(_tokens.length!==fields.length)return console.log(_tokens),["line "+lineno+": wrong number of fields"];for(var row={},_i2=0;_i2<fields.length;++_i2)row[fields[_i2]]=_tokens[_i2];rows[rows.length]=row,lineno+=1}return[null,rows]}function toString(rows,options){var fields=options.fields,sep=options.separator,quote=options.quote;if(void 0===fields)return["no fields specified",null];if(void 0===sep)return["no separator specified",null];var writer=void 0;writer=void 0!==quote?function(field){return field=(""+field).replace(quote,"\\"+quote),'"'+field+'"'}:function(field){return field};var result=[];if(options.hasHeader){for(var rowStrings=[],f=0;f<fields.length;++f)rowStrings[rowStrings.length]=writer(fields[f]);result[result.length]=rowStrings.join(sep)}for(var i=0;i<rows.length;++i){for(var row=rows[i],_rowStrings=[],_f=0;_f<fields.length;++_f){if(void 0===row[fields[_f]])return["missing field "+fields[_f]+" in row "+i,null];null===row[fields[_f]]&&(row[fields[_f]]=""),_rowStrings[_rowStrings.length]=writer(row[fields[_f]])}result[result.length]=_rowStrings.join(sep)}return[null,result.join("\n")]}return{fromString:fromString,toString:toString}}();!function($){$.fn.droppable=function(optsOrFn,MaybeFn){var opts={},cb=void 0;return"function"==typeof optsOrFn?cb=optsOrFn:(opts=$.extend({},opts,optsOrFn),cb=MaybeFn),this.each(function(){var _this=this;$(this).on("drop",function(event){event.stopPropagation(),event.preventDefault();var file=event.originalEvent.dataTransfer.files[0];$(_this).css("background-color","#FFFFFF"),cb(file)}),$(this).on("dragover",function(event){event.stopPropagation(),event.preventDefault(),event.originalEvent.dataTransfer.dropEffect="copy"}),$(this).on("dragenter",function(event){$(_this).css("background-color","#F0F0F0")}),$(this).on("dragleave",function(event){$(_this).css("background-color","#FFFFFF")})})}}(jQuery),function($){function delayedOnce(fn,timeout){function wrappedFn(){fn.apply(null,args),timeoutHandler=null}var timeoutHandler=null,args=[];return function(){null!==timeoutHandler&&clearTimeout(timeoutHandler),args=arguments,timeoutHandler=setTimeout(wrappedFn,1e3*timeout)}}function click(table,body,event){var target=($(table).data("egrid"),$(event.target));target.attr("data-type")}function dblClick(table,body,event){var data=$(table).data("egrid"),target=$(event.target),type=target.attr("data-type");if("cell"==type){var row=parseInt(target.parent().attr("data-row")),col=parseInt(target.attr("data-col"));data.editing===!1&&data.columns[col].editable!==!1&&(editStartRow(table,row),editStartCol(table,col))}}function editOnKeyDown(table,event){var data=table.data("egrid");data.input;if(data.editing!==!1){if("Enter"===event.key&&(editSubmitCol(table),editSubmitRow(table),editEnd(table)),"Escape"===event.key&&editEnd(table),"Tab"===event.key){event.preventDefault();var _data$editing=data.editing,col=(_data$editing.row,_data$editing.col);!event.shiftKey&&col<data.columns.length-1&&(editSubmitCol(table),editStartCol(table,col+1)),event.shiftKey&&col>0&&data.columns[col-1].editable&&(editSubmitCol(table),editStartCol(table,col-1))}if("ArrowUp"===event.key&&event.altKey===!0){var _data$editing2=data.editing,_row=_data$editing2.row,_col=_data$editing2.col;_row>0&&(editSubmitCol(table),editSubmitRow(table),data.editing=!1,editStartRow(table,_row-1),editStartCol(table,_col))}if("ArrowDown"===event.key&&event.altKey===!0){var _data$editing3=data.editing,_row2=_data$editing3.row,_col2=_data$editing3.col;_row2<data.rows.length-1&&(editSubmitCol(table),editSubmitRow(table),data.editing=!1,editStartRow(table,_row2+1),editStartCol(table,_col2))}}}function editOnFocusOut(table,event){var data=table.data("egrid"),_data$editing4=data.editing,col=_data$editing4.col,row=_data$editing4.row;data.editing!==!1&&setTimeout(function(){var data=table.data("egrid"),newCol=data.editing.col,newRow=data.editing.row;newCol==col&&newRow==row&&editEnd(table)},1)}function editStartRow(table,row){var data=table.data("egrid");if(data.editing!==!1)throw"trying to edit multiple rows";var oldRow=$.extend({},data.rows[row]),newRow=$.extend({},data.rows[row]);data.editing={row:row,oldData:oldRow,newData:newRow},table.data("egrid",data);var input=data.input;input.on("keydown",function(event){editOnKeyDown(table,event)}),input.on("focusout",function(event){editOnFocusOut(table,event)}),void 0!==data.onStartEdit&&data.onStartEdit(oldRow)}function editSubmitRow(table){var data=table.data("egrid"),_data$editing5=data.editing,row=_data$editing5.row,newData=_data$editing5.newData;data.rows[row]=newData,table.data("egrid",data),updateRows(table);var input=data.input;input.off("keydown"),input.off("focusout"),input.remove(),void 0!==data.onEdited&&data.onEdited(newData)}function editStartCol(table,col){var data=table.data("egrid"),ids=data.ids,input=data.input,scrollBox=data.scrollBox,body=data.body,_data$editing6=(data.columns,data.editing),row=_data$editing6.row,newData=_data$editing6.newData,cell=$(body[0].children[row].children[col]),_ref=[cell[0].offsetLeft,cell[0].offsetTop],left=_ref[0],top=_ref[1],_cell$0$getBoundingCl=cell[0].getBoundingClientRect(),width=_cell$0$getBoundingCl.width,height=_cell$0$getBoundingCl.height;input.css({position:"absolute",left:left+"px",top:top+"px",width:width+"px",height:height+"px"}),scrollBox.append(input),input.val(newData[ids[col]]),input.focus(),input.select(),data.editing.col=col,table.data("egrid",data)}function editSubmitCol(table){var data=table.data("egrid"),ids=data.ids,input=data.input,body=data.body,_data$editing7=(data.columns,data.editing),row=_data$editing7.row,col=_data$editing7.col,newData=_data$editing7.newData;newData[ids[col]]=input.val();var cell=$(body[0].children[row].children[col]);cell.text(newData[ids[col]]),table.data("egrid",data)}function editEnd(table){var data=table.data("egrid"),input=data.input;data.editing=!1,input.remove(),table.data("egrid",data),updateRows(table),void 0!==data.onEndEdit&&data.onEndEdit(),window.getSelection().removeAllRanges()}function updateSize(elem){for(var data=elem.data("egrid"),columns=data.columns,head=data.head,body=data.body,width=body[0].clientWidth,availableWidth=width,widths=[],i=0;i<columns.length;++i)widths[i]=availableWidth/columns.length+"px";for(var headCells=head.children(),_i3=0;_i3<headCells.length;++_i3){var cell=$(headCells[_i3]);cell.css("width",widths[_i3])}for(var rows=body.children(),_i4=0;_i4<rows.length;++_i4)for(var cells=$(rows[_i4]).children(),j=0;j<cells.length;++j){var _cell=$(cells[j]);_cell.css("width",widths[j])}}function copyRows(rows,ids){for(var result=[],i=0;i<rows.length;++i){var row={};for(var j in ids){var id=ids[j],val=rows[i][id];null!==val&&void 0!==val?row[id]=val:row[id]=""}result[i]=row}return result}function updateData(elem,rows){for(var data=elem.data("egrid"),columns=data.columns,extraFields=data.extraFields,ids=[],i=0;i<columns.length;++i)ids[i]=columns[i].id;for(var _i5=0;_i5<extraFields.length;++_i5)ids[columns.length+_i5]=extraFields[_i5];data.rows=copyRows(rows,ids),elem.data("egrid",data),updateRows(elem)}function joinClasses(){for(var className=void 0,i=0;i<arguments.length;++i)void 0===arguments[i]||null===arguments[i]&&""===arguments[i]||(void 0===className?className=arguments[i]:className+=" "+arguments[i]);return className}function updateRows(elem){for(var _elem$data=elem.data("egrid"),onStyleRow=_elem$data.onStyleRow,columns=_elem$data.columns,rows=_elem$data.rows,body=_elem$data.body,rowNumberChanged=!1;body.children().length>rows.length;)body.children().first().remove(),rowNumberChanged=!0;for(;body.children().length<rows.length;){var rowElem=$("<div>");rowElem.attr("data-type","row");for(var i=0;i<columns.length;++i){var cellElem=$("<div>");cellElem.attr("data-type","cell"),rowElem.append(cellElem)}body.append(rowElem),rowNumberChanged=!0}for(var rowElems=body[0].children,_i6=0;_i6<rows.length;++_i6){var row=rows[_i6],_rowElem=rowElems[_i6],styles={};onStyleRow&&(styles=onStyleRow(row)||{}),_rowElem.setAttribute("data-row",_i6),_rowElem.className=joinClasses("egrid-body-row",styles.row);for(var j=0;j<columns.length;++j){var _cellElem=_rowElem.children[j],id=columns[j].id,val=rows[_i6][id];_cellElem.innerHTML=val,_cellElem.setAttribute("data-col",j),_cellElem.className=joinClasses("egrid-body-cell",columns[j].class,styles[id])}}updateSize(elem)}function updateColumns(elem,_columns){var data=elem.data("egrid");if(void 0===data)throw"can't set columns on uninitialized egrid";for(var columns=[],ids=[],i=0;i<_columns.length;++i){if(void 0===_columns[i].id)throw"tried to add column without id";ids[i]=_columns[i].id,columns[i]=$.extend({editable:!0},_columns[i])}data.ids=ids,data.columns=columns,elem.data("egrid",data);var head=data.head,body=data.body;head.empty();for(var _i7=0;_i7<columns.length;++_i7){var cell=$("<div>").addClass("egrid-head-cell");"class"in columns[_i7]&&cell.addClass(columns[_i7].class),cell.text(columns[_i7].title),head.append(cell)}body.empty()}function setupBasics(elem){var head=$("<div>").addClass("egrid-head"),scrollBox=$("<div>").addClass("egrid-scrollbox"),body=$("<div>").addClass("egrid-body"),input=$("<input>").addClass("egrid-input");elem.empty(),elem.resize(function(){resize(elem)}),elem.addClass("egrid"),scrollBox.append(body),elem.append(head).append(scrollBox),body.on("dblclick",function(event){dblClick(elem,body,event)}),body.on("click",function(event){click(elem,body,event)}),elem.data("egrid",{editing:!1,rows:[],input:input,head:head,scrollBox:scrollBox,body:body})}function extendSome(names,target,source){for(var i=0;i<names.length;++i){var name=names[i];void 0!==source[name]&&(target[name]=source[name])}}function commands(table,command,args){table.data("egrid");if("refresh"!=command)throw"unknown command "+command;updateRows(table)}function config(elem,opts){if(void 0===opts.columns&&void 0===opts.data)throw"cannot configure egrid without neither columns or data";void 0===elem.data("egrid")&&setupBasics(elem);var data=elem.data("egrid");extendSome(["onStartEditing","onEndEditing","onEdited","onStyleRow","extraFields"],data,opts),void 0===data.extraFields&&(data.extraFields=[]),elem.data("egrid",data),"columns"in opts&&updateColumns(elem,opts.columns),"data"in opts&&updateData(elem,opts.data)}var resize=delayedOnce(function(table){updateSize(table)},.25);$.fn.egrid=function(opts){var _this2=this,args=arguments;return this.each(function(){var elem=$(_this2);"string"==typeof opts?commands(elem,args[0],[].concat(_toConsumableArray(args)).slice(1)):config(elem,opts)})}}(jQuery);var geo=function(){function clearCache(){cache.clear()}function geocodeWithNext(address,callback,providers){providers.length<1?callback("not found",null):!function(){var coder=providers[0],rest=providers.slice(1);coder.code(address,function(err,results){return null===err&&results.length>0?(coder!==cache&&cache.add(address,results),console.log("address resolved by "+coder.name),void callback(null,results)):void geocodeWithNext(address,callback,rest)})}()}function geocode(address,callback){address.toLowerCase().indexOf("mannheim")===-1&&(address+=", Mannheim"),geocodeWithNext(address,callback,[cache,nominatim])}function geodecode(lat,lng,callback){callback("not implemented",null)}var cache=function(){function code(address,callback){var err=void 0,res=["not found",null];try{var cacheRaw=localStorage.getItem("geo.cache"),_cache=JSON.parse(cacheRaw);if(address in _cache){var _ref2=[null,_cache[address]];err=_ref2[0],res=_ref2[1]}}catch(e){}callback(err,res)}function add(address,results){var cache=void 0;try{var cacheRaw=localStorage.getItem("geo.cache");cache=JSON.parse(cacheRaw)||{}}catch(e){cache={}}cache[address]=results,localStorage.setItem("geo.cache",JSON.stringify(cache))}function clear(){localStorage.setItem("geo.cache",null)}return{name:"cache",code:code,add:add,clear:clear}}(),nominatim=function(){function code(address,callback){$.ajax({type:"GET",url:"https://nominatim.openstreetmap.org/search",dataType:"jsonp",jsonp:"json_callback",data:{format:"jsonv2",q:address},success:function(results){for(var list=[],i=0;i<results.length;++i){var res={};try{res.lat=results[i].lat,res.lng=results[i].lon,res.streetAddress=results[i].display_name,list[list.length]=res}catch(e){}}callback(null,list)},error:function(xhr,err){callback(err,null)}})}return{name:"openstreetmap",code:code}}();(function(){function code(address,callback){geocoder.geocode({address:address},function(results,status){if(status==google.maps.GeocoderStatus.OK){for(var list=[],i=0;i<results.length;++i){var res={};try{res.lat=results[i].geometry.location.lat(),res.lng=results[i].geometry.location.lng(),res.streetAddress=results[i].formatted_address,list[list.length]=res}catch(e){}}callback(null,list)}else callback("not found",null)})}var geocoder=new google.maps.Geocoder;return{code:code,name:"google"}})();return{clearCache:clearCache,code:geocode,decode:geodecode}}(),calcCrow=function(p1,p2){function toRad(Value){return Value*Math.PI/180}var _p=_slicedToArray(p1,2),_lat1=_p[0],lon1=_p[1],_p2=_slicedToArray(p2,2),_lat2=_p2[0],lon2=_p2[1],R=6371,dLat=toRad(_lat2-_lat1),dLon=toRad(lon2-lon1),lat1=toRad(_lat1),lat2=toRad(_lat2),a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.sin(dLon/2)*Math.sin(dLon/2)*Math.cos(lat1)*Math.cos(lat2),c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)),d=R*c;return d},cursor3d=function(data,nx,ny,nz){return function(x,y,z,val){var idx=0;return idx+=x,idx+=y*nx,idx+=z*nx*ny,void 0===val?data[idx]:void(data[idx]=val)}},randomSet=function(){function _del(set,val){if(void 0===set[val])throw"element not in set!";delete set[val]}function _has(set,val){return set[val]===!0}function _add(set,val){if(set[val]===!0)throw"element already in set!";set[val]=!0}function _get(set){return Object.keys(set)}function _pick(set){if(0==Object.keys(set).length)throw"trying to pick/pop from empty set";var keys=Object.keys(set),val=keys[keys.length*Math.random()<<0];return val}function _pop(set){var val=_pick(set);return _del(set,val),val}function augment(obj){return{has:function(val){return _has(obj,val)},get:function(val){return _get(obj)},add:function(val){return _add(obj,val)},del:function(val){return _del(obj,val)},pick:function(){return _pick(obj)},pop:function(){return _pop(obj)}}}function fromArray(arr){if("object"!==("undefined"==typeof arr?"undefined":_typeof(arr)))throw"expected array as argument";for(var set={},i=0;i<arr.length;++i){if("object"===_typeof(arr[i]))throw"cannot use objects as keys";set[arr[i]]=!0}return augment(set)}function fromRange(min,max){for(var set={},i=0;i<max;++i)set[i]=!0;return augment(set)}function fromEmpty(){return augment({})}return{fromArray:fromArray,fromRange:fromRange,fromEmpty:fromEmpty}}(),matching=function(){function makeConfig(_teams,_dishes){var nteams=_teams.length,ndishes=_dishes.length,ngroups=nteams/ndishes;if(nteams%ndishes!=0)return["number of teams ("+nteams+") not divisable by number of dishes ("+ndishes+")!",null];for(var teams=[],i=0;i<nteams;++i)teams.push({id:_teams[i].id,lat:_teams[i].lat,lng:_teams[i].lng});var dishes=_dishes.slice();return[null,{nteams:nteams,ndishes:ndishes,ngroups:ngroups,teams:teams,dishes:dishes}]}function initialMatch(config){for(var nteams=config.nteams,ndishes=config.ndishes,ngroups=config.ngroups,availCooks=(config.assignments,randomSet.fromRange(0,nteams)),match={nx:ndishes,ny:ngroups,nz:ndishes,data:[]},nx=ndishes,ny=ngroups,nz=ndishes,arr=match.data,i=0;i<nx*ny*nz;++i)arr[i]=-1;for(var val=cursor3d(arr,nx,ny,nz),_i8=0;_i8<ndishes;++_i8){for(var availGuests=randomSet.fromRange(0,nteams),j=0;j<ngroups;++j){var cook=parseInt(availCooks.pop());availGuests.del(cook),val(_i8,j,0,cook)}for(var _j=0;_j<ngroups;++_j)for(var k=1;k<ndishes;++k){var guest=parseInt(availGuests.pop());val(_i8,_j,k,guest)}}return match}function shuffleMatch(config,match,tsProb,ssProb){match={nx:match.nx,ny:match.ny,nz:match.nz,data:match.data.slice()};var val=cursor3d(match.data,match.nx,match.ny,match.nz),nteams=config.nteams,ndishes=config.ndishes,ngroups=config.ngroups;if(isNaN(tsProb[0])||isNaN(tsProb[1])||isNaN(ssProb[0])||isNaN(ssProb[1]))throw"bad probabilities";for(var _tsProb=_slicedToArray(tsProb,2),rolls=_tsProb[0],chance=_tsProb[1],_=0;_<rolls;++_)if(!(Math.random()>chance)){for(var team1=nteams*Math.random()<<0,team2=nteams*Math.random()<<0;team2===team1;)team2=nteams*Math.random()<<0;for(var team1List=[],team2List=[],dish=0;dish<ndishes;++dish)for(var group=0;group<ngroups;++group)for(var seat=0;seat<ndishes;++seat)val(dish,group,seat)===team1&&(team1List[team1List.length]=[dish,group,seat]),val(dish,group,seat)===team2&&(team2List[team2List.length]=[dish,group,seat]);if(team1List.length!=ndishes||team2List.length!=ndishes)throw"WHOOPS! Team occurences not right";for(var i=0;i<ndishes;++i){var _team1List$i=_slicedToArray(team1List[i],3),_dish=_team1List$i[0],_group=_team1List$i[1],_seat=_team1List$i[2];val(_dish,_group,_seat,team2)}for(var _i9=0;_i9<ndishes;++_i9){var _team2List$_i=_slicedToArray(team2List[_i9],3),_dish2=_team2List$_i[0],_group2=_team2List$_i[1],_seat2=_team2List$_i[2];val(_dish2,_group2,_seat2,team1)}}var _ssProb=_slicedToArray(ssProb,2);rolls=_ssProb[0],chance=_ssProb[1];for(var _2=0;_2<rolls;++_2){config.dishes;if(!(Math.random()>chance)){for(var _dish3=ndishes*Math.random()<<0,_seat3=ndishes*Math.random()<<0,group1=ngroups*Math.random()<<0,group2=ngroups*Math.random()<<0;group2==group1;)group2=ngroups*Math.random()<<0;var _team=val(_dish3,group1,_seat3),_team2=val(_dish3,group2,_seat3);val(_dish3,group1,_seat3,_team2),val(_dish3,group2,_seat3,_team)}}return match}function asLong(config,match){for(var nteams=config.nteams,ndishes=config.ndishes,ngroups=config.ngroups,val=cursor3d(match.data,match.nx,match.ny,match.nz),long=[],team=0;team<nteams;++team)long[team]=[-1,-1,-1,-1];for(var dish=0;dish<ndishes;++dish)for(var group=0;group<ngroups;++group){var cooking=val(dish,group,0);long[cooking][0]=dish;for(var seat=0;seat<ndishes;++seat){var _team3=val(dish,group,seat);long[_team3][dish+1]=cooking}}return long}function asList(config,match){for(var teams=config.teams,dishes=config.dishes,long=asLong(config,match),result=[],i=0;i<long.length;++i){var row={};row.teamId=teams[i].id,row.cooking=dishes[long[i][0]];for(var j=0;j<dishes.length;++j)long[i][j+1]!==-1&&(row[dishes[j]]=teams[long[i][j+1]].id);result[result.length]=row}return result}function asFull(config,match){for(var teams=config.teams,dishes=config.dishes,ndishes=config.ndishes,ngroups=config.ngroups,nteams=config.nteams,val=cursor3d(match.data,match.nx,match.ny,match.nz),long=asLong(config,match),result=[],i=0;i<nteams;++i){result[i]={teamId:teams[i].id,cooking:dishes[long[i][0]]};for(var j=0;j<ndishes;++j)result[i][dishes[j]]=[]}for(var dish=0;dish<ndishes;++dish)for(var group=0;group<ngroups;++group)for(var seatA=0;seatA<ndishes;++seatA)for(var dishName=dishes[dish],team=val(dish,group,seatA),seatB=0;seatB<ndishes;++seatB){var other=val(dish,group,seatB);result[team][dishName].push(teams[other].id)}return result}function matchPattern(text,what){var tokens=text.match(/\S+/g);if(null===tokens)return null;if(tokens.length!==what.length)return null;for(var values=[],i=0;i<what.length;++i)if("*"===what[i])values[values.length]=tokens[i];else if(what[i]!==tokens[i])return null;return values}function parseConstraints(text){for(var lines=text.split("\n"),errors=[],cns=[],i=0;i<lines.length;++i){var line=lines[i].trim();if(""!==line){var match=void 0;match=matchPattern(line,["teams","meet","once"]),match?cns[cns.length]={type:"onlyOnce",line:i+1}:(match=matchPattern(line,["ways","short"]),match?cns[cns.length]={type:"shortWays",line:i+1}:(match=matchPattern(line,["ways","similar"]),match?cns[cns.length]={type:"sameWays",line:i+1}:(match=matchPattern(line,["*","cooks","*"]),match?cns[cns.length]={type:"dish",teamId:match[0],dish:match[1],pos:!0,line:i+1}:(match=matchPattern(line,["*","not","cooks","*"]),match?cns[cns.length]={type:"dish",teamId:match[0],dish:match[1],pos:!1,line:i+1}:(match=matchPattern(line,["*","meets","*"]),match?cns[cns.length]={type:"pair",teamId1:match[0],teamId2:match[1],pos:!0,line:i+1}:(match=matchPattern(line,["*","not","meets","*"]),match?cns[cns.length]={type:"pair",teamId1:match[0],teamId2:match[1],pos:!1,line:i+1}:errors[errors.length]=[i+1,"unknown rule"]))))))}}return[errors,cns]}function checkConstraints(teams,dishes,cns){for(var errors=[],i=0;i<cns.length;++i){var cn=cns[i];if("dish"===cn.type){for(var found=!1,j=0;j<teams.length;++j)if(teams[j].id===cn.teamId){found=!0;break}found||(errors[errors.length]=[i,"did not find team "+cn.teamId]),found=!1;for(var _j2=0;_j2<dishes.length;++_j2)if(dishes[_j2]===cn.dish){found=!0;break}found||(errors[errors.length]=[i,"dish "+cn.dish+" does not exist"])}if("pair"===cn.type){cn.teamId1===cn.teamId2&&(errors[errors.length]=[i,"used the same team twice"]);for(var found1=!1,found2=!1,_j3=0;_j3<teams.length&&(teams[_j3].id===cn.teamId1&&(found1=!0),teams[_j3].id===cn.teamId2&&(found2=!0),!found1||!found2);++_j3);found1||(errors[errors.length]=[i,"did not find team "+cn.teamId1]),found2||(errors[errors.length]=[i,"did not find team "+cn.teamId2])}}return errors}function score(config,cns,match){for(var total=0,partials=[],long=asLong(config,match),i=0;i<cns.length;++i){var cn=cns[i];if(void 0===scoreFns[cn.type])throw"WHOOPS! Unknown constraint";var _score2=scoreFns[cn.type](config,cn,match,long);total+=_score2[0],partials[partials.length]=_score2}return{total:total,partials:partials}}var scoreFns={};return scoreFns.onlyOnce=function(config,cn,match,long){for(var ndishes=config.ndishes,ngroups=config.ngroups,val=(config.nteams,cursor3d(match.data,match.nx,match.ny,match.nz)),weight=cn.weight||1e4,visited={},multiple=0,dish=0;dish<ndishes;++dish)for(var group=0;group<ngroups;++group){for(var guests=[],seatA=0;seatA<ndishes;++seatA){var team=val(dish,group,seatA);guests[guests.length]=team;for(var seatB=0;seatB<ndishes;++seatB)if(seatA!=seatB){var other=val(dish,group,seatB);void 0==visited[other]&&(visited[other]={}),void 0!==visited[other][team]&&(multiple+=1)}}for(var _seatA=0;_seatA<ndishes;++_seatA)for(var _team4=val(dish,group,_seatA),_seatB=0;_seatB<ndishes;++_seatB)if(_seatA!=_seatB){var _other=val(dish,group,_seatB);visited[_other][_team4]=!0}}return 0===multiple?[0,"ok","no teams meet more than once"]:[multiple*weight,"bad","teams have met multiple times"]},scoreFns.shortWays=function(config,cn,match,long){for(var teams=config.teams,ndishes=config.ndishes,score=(config.nteams,config.ngroups,cn.weight||2,0),i=0;i<long.length;++i)for(var j=1;j<ndishes;++j){var start=teams[long[i][j]],end=teams[long[i][j+1]];score+=calcCrow([start.lat,start.lng],[end.lat,end.lng])}return[score,"ok","based on total distance traveled"]},scoreFns.sameWays=function(config,cn,match,long){for(var ndishes=config.ndishes,weight=(config.nteams,config.ngroups,cn.weight||2),distances=[],sum=0,i=0;i<long.length;++i)for(var j=1;j<ndishes;++j){var start=teams[long[i][j]],end=teams[long[i][j+1]],dist=calcCrow([start.lat,start.lng],[end.lat,end.lng]);sum+=dist,distances[distances.length]=dist}var dev=(sum/distances.length,distances.reduce(function(a,b){return a+b})/distances.length),score=dev*weight;return[score,"ok",'based on "unfairness" of distances']},scoreFns.dish=function(config,cn,match,long){for(var dishes=config.dishes,teams=config.teams,weight=(config.ndishes,config.nteams,config.ngroups,cn.weight||100),dishName=cn.dish,teamId=cn.teamId,positive=cn.pos,dish=dishes.indexOf(dishName),team=-1,i=0;i<teams.length;++i)if(teams[i].id===teamId){team=i;break}var hasDish=long[team][0]===dish,ok=hasDish&&positive||!hasDish&&!positive;return ok?[0,"ok",""]:[weight,"bad","team "+teamId+" has unwanted dish"]},scoreFns.pair=function(config,cn,match,long){return[5,"bad","not implemented"]},{makeConfig:makeConfig,initialMatch:initialMatch,shuffleMatch:shuffleMatch,parseConstraints:parseConstraints,checkConstraints:checkConstraints,asList:asList,asLong:asLong,asFull:asFull,score:score}}(),teamsModel=function(){function lockModified(){lockm=!0}function unlockModified(){lockm=!1,sig.emit("teams-modified")}function clear(){store=[],lockm||sig.emit("teams-modified")}function makeIndex(row){var attempt=row.cook1name.substring(0,1).toLowerCase()+row.cook1last.substring(0,1).toLowerCase()+row.cook2name.substring(0,1).toLowerCase()+row.cook2last.substring(0,1).toLowerCase();if(attempt in store){for(var i=1;attempt+i in store;)i+=1;return attempt+i}return attempt}
function hasRequired(row,fields){for(var i=0;i<fields.length;++i)if(!(fields[i]in row)||""==row[fields[i]])return!1;return!0}function addRow(row){if(!hasRequired(row,["cook1name","cook1last","cook2name","cook2last"]))return[!1,"required field is missing"];var id=makeIndex(row),newRow={id:id,cook1name:row.cook1name,cook1last:row.cook1last,cook1mail:row.cook1mail,cook2name:row.cook2name,cook2last:row.cook2last,cook2mail:row.cook2mail,address:row.address,phone:row.phone,comments:row.comments||null,lat:isNaN(row.lat)?null:parseFloat(row.lat),lng:isNaN(row.lng)?null:parseFloat(row.lng)};return ids[id]=!0,store.push(newRow),store.sort(function(a,b){return a.id<b.id?-1:1}),lockm||sig.emit("teams-modified"),[id,null]}function updateRow(row){if(!("id"in row))return[!1,"id is missing"];for(var i=0;i<store.length;++i)if(store[i].id===row.id){"cook1name"in row&&(store[i].cook1name=row.cook1name),"cook1last"in row&&(store[i].cook1last=row.cook1last),"cook1mail"in row&&(store[i].cook1mail=row.cook1mail),"cook2name"in row&&(store[i].cook2name=row.cook2name),"cook2last"in row&&(store[i].cook2last=row.cook2last),"cook2mail"in row&&(store[i].cook2mail=row.cook2mail),"address"in row&&(store[i].address=row.address),"phone"in row&&(store[i].phone=row.phone),"comments"in row&&(store[i].comments=row.comments),"lat"in row&&!isNaN(row.lat)&&(store[i].lat=parseFloat(row.lat)),"lng"in row&&!isNaN(row.lng)&&(store[i].lng=parseFloat(row.lng)),lockm||sig.emit("teams-modified");break}}function getOne(id){for(var i=0;i<store.length;++i)if(store[i].id===id)return $.extend({},store[i]);return null}function get(fn){void 0===fn&&(fn=function(){return!0});for(var result=[],i=0;i<store.length;++i)fn(store[i])&&result.push($.extend({},store[i]));return result}function getAll(){return get(function(){return!0})}function getNumber(){return store.length}function reset(){store=[],ids=ids}function serialize(){return JSON.stringify(store)}function deserialize(data){for(var newStore=JSON.parse(data),newIds={},i=0;i<newStore.length;++i)newIds[newStore[i].id]=!0;store=newStore,ids=newIds,lockm||sig.emit("teams-modified")}var ids={},store=[],lockm=!1;return{clear:clear,makeId:makeIndex,addRow:addRow,updateRow:updateRow,getOne:getOne,get:get,getAll:getAll,getNumber:getNumber,reset:reset,serialize:serialize,deserialize:deserialize,lockModified:lockModified,unlockModified:unlockModified}}(),rulesModel=function(){function set(_text){text=_text,sig.emit("rules-modified")}function get(){return void 0===text&&reset(),text}function reset(){set(defaults.rules())}function serialize(){return text}function deserialize(text){set(text)}var text=void 0;return{get:get,set:set,reset:reset,serialize:serialize,deserialize:deserialize}}(),mapModel=function(){function getBounds(){return[bounds[0],bounds[1],bounds[2],bounds[3]]}function geoToLocal(lat,lng,width,height){var x=(lng-bounds[1])*width/(bounds[3]-bounds[1]),y=(lat-bounds[0])*height/(bounds[2]-bounds[0]);return[x,y]}function localToGeo(x,y,width,height){var lat=y/height*(bounds[2]-bounds[0])+bounds[0],lng=x/width*(bounds[3]-bounds[1])+bounds[1];return[lat,lng]}function isWithinBounds(lat,lng){return lat>bounds[2]&&lat<bounds[0]&&lng>bounds[1]&&lng<bounds[3]}var bounds=[49.5054,8.4318,49.4695,8.5006];return{isWithinBounds:isWithinBounds,getBounds:getBounds,geoToLocal:geoToLocal,localToGeo:localToGeo}}();!function($){$.fn.dropdownmulti=function(items,options){var _this3=this;return this.each(function(){function show(){elem.parent().append(menu);var _elem$position=elem.position(),left=_elem$position.left,top=_elem$position.top;top+=elem.height(),menu.css({display:"block",left:left+"px",top:top+"px"}),visible=!0,onOpen&&onOpen()}function hide(){menu.css("display","none"),visible=!1,onClose&&onClose(choices)}for(var elem=$(_this3),menu=$("<div>").addClass("dropdownmulti-menu"),choices={},onChanged=options.onChanged,onOpen=options.onOpen,onClose=options.onClose,visible=!1,_loop=function(i){var _items$i=_slicedToArray(items[i],3),title=_items$i[0],value=_items$i[1],def=_items$i[2],item=$("<div>").addClass("dropdownmulti-item"),checkbox=$("<input>").attr("type","checkbox").addClass("dropdownmulti-checkbox"),text=$("<span>").addClass("dropdownmulti-text").text(title);def=!!def,choices[value]=def,checkbox.prop("checked",def),item.append(checkbox),item.append(text),menu.append(item),checkbox.on("focus",function(e){checkbox.blur()}),checkbox.on("click",function(e){checkbox.prop("checked",!checkbox.prop("checked"))}),item.on("click",function(e){e.stopPropagation();var checked=!checkbox.prop("checked");checkbox.prop("checked",checked),choices[value]=checked,onChanged&&onChanged(choices)})},i=0;i<items.length;++i)_loop(i);menu.css({display:"none",position:"absolute","z-index":999}),$(document).on("click",function(e){visible&&hide()}),elem.on("click",function(e){visible||(e.preventDefault(),e.stopPropagation(),show())})})}}(jQuery);var persistence=function(){function saveLocal(){for(var i=0;i<models().length;++i){var _models$i=_slicedToArray(models()[i],2),name=_models$i[0],model=_models$i[1],serialized=model.serialize();localStorage.setItem(localStoragePrefix+name,serialized)}sig.emit("all-saved")}function loadLocal(){for(var i=0;i<models().length;++i){var _models$i2=_slicedToArray(models()[i],2),name=_models$i2[0],model=_models$i2[1],raw=localStorage.getItem(localStoragePrefix+name);void 0!==raw&&null!==raw&&model.deserialize(raw)}sig.emit("all-loaded")}function clearLocal(){for(var i=0;i<models().length;++i){var _models$i3=_slicedToArray(models()[i],2),name=_models$i3[0],model=_models$i3[1];localStorage.removeItem(localStoragePrefix+name),model.reset()}}var localStoragePrefix="local-",models=function(){return[["teams",teamsModel],["rules",rulesModel],["match",bestMatching],["mails",mails]]};return{save:saveLocal,load:loadLocal,clear:clearLocal}}(),defaults=function(){var _rules="teams meet once\nways short\n",_mailsHelp="\nJust type in whatever you want to your mail to look like.\nIn order to customize it to whoever it is going to, you can use\nvariables that then get replaced by their corresponding value.\nTo use variables, type $(variable name), so if you'd want to use\nthe variable 'cook1name' you'd type $(cook1name).\n\nThe available variable are:\n\nrecipient1: Name (First and Last) of the first person this mail goes to\nrecipient2: Same for the second person\n\nstarterCookName1: Name of the first person of the cooks of the starter\nstarterCookName2: ...\nstarterCookAddress: Address of the host of the starter\nstarterCookPhone: Phone number of the starter's host\nstarterCookComments: Comments of the starter's cooks\nstarterGuest1Name1: Name of first person of the first guest team\nstarterGuest1Name2: ...\nstarterGuest1Comments: Comments of the first guest team\nstarterGuest2Name1: Name of first person of the first guest team\nstarterGuest2Name2: ...\nstarterGuest2Comments: Comments of the first guest team\n\nReplace 'starter' with 'main' and 'dessert' to get your variables for\nthe other dishes.\n\nIn order to double check the generated mails, first click 'Download Mails'.\nThis generates a file that contains all generated emails and the mail addresses\nthey're intended for. You do NOT send anything by clicking this button.\n\nIf you're happy with the generated mails, fill in the email address and the\npassword you want to send the mails from and click 'Send Mails'.\n".trim(),_rulesHelp='\n  <h1>Reference</h1>\n\n  A red marker means there is an error with that rule,\n  no marker means everything in that line is fine. Just move your mouse\n  over the red marker to get an error description.\n  <br/>\n  <br/>\n  <div class="command">teams meet once</div>\n  Add HUGE penalty for teams meeting twice or more (always have this on)</br>\n  <br/>\n  <div class="command">ways short</div>\n  Optimize for shortest distance</br>\n  <br/>\n  <div class="command">ways similar</div>\n  Optimize for similar distances</br>\n  <br/>\n  <div class="command">{team} cooks [starter|main|dessert]</div>\n  <div class="command">{team} not cooks [starter|main|dessert]</div>\n  Specifies that a team either wants or does not want to cook a specific dish, e.g.:<br/>\n  &nbsp;&nbsp; alss cooks starter</br>\n  &nbsp;&nbsp; jxfz not cooks main</br>\n  </div>\n  '.trim(),_dishes2=["starter","main","dessert"];return{rules:function(){return _rules},mailsHelp:function(){return _mailsHelp},rulesHelp:function(){return _rulesHelp},dishes:function(){return _dishes2}}}(),tabs=function(){function init(tabpane,contentpane){tp=tabpane,cp=contentpane}function add(config){var name=config.name,text=config.text;config.init;if(name in tabs)throw"tab already registered!";var tab=$("<div>").addClass("tab-link");tab.text(text),tab.click(function(event){tryActivate(name)}),$(tp).append(tab);var view=$("<div>").addClass("tab-view");view.attr("view",name),view.css("display","none"),$(cp).append(view),config.onInit(view),tabs[name]={name:name,text:text,tab:tab,view:view,onActivate:config.onActivate,onBeforeDeactivate:config.onBeforeDeactivate,onDeactivate:config.onDeactivate}}function addSpacer(){var spacer=$('<div class="tab-spacer"></div>');$(tp).append(spacer)}function activate(name){if(!name in tabs)throw"trying to activate unknown tab!";""!=active&&(tabs[active].tab.removeClass("tab-active"),tabs[active].view.css("display","none"),tabs[active].onDeactivate&&tabs[active].onDeactivate()),active=name,tabs[name].tab.addClass("tab-active"),tabs[name].view.css("display","block"),tabs[name].onActivate&&tabs[name].onActivate()}function tryActivate(name){active!=name&&(active in tabs&&tabs[active].onBeforeDeactivate?tabs[active].onBeforeDeactivate(function(){activate(name)}):activate(name))}var cp=null,tp=null,active="",tabs={};return{init:init,add:add,addSpacer:addSpacer,tryActivate:tryActivate}}(),mails=function(){function setMail(type,mail){if(defaults.dishes().indexOf(type)===-1)throw"WHOOPS! invalid mail "+type;mails[type]=mail,sig.emit("mails-modified")}function getMail(type){if(defaults.dishes().indexOf(type)===-1)throw"WHOOPS! invalid mail "+type;return mails[type]||""}function reset(){mails={}}function serialize(){return JSON.stringify(mails)}function deserialize(raw){mails=JSON.parse(raw)||{},sig.emit("mails-modified")}var mails={};return{getTypes:defaults.dishes,serialize:serialize,deserialize:deserialize,reset:reset,setMail:setMail,getMail:getMail}}(),vMails=function(){function updateOptions(){mailSelect.empty();for(var dishes=defaults.dishes(),i=0;i<dishes.length;++i)mailSelect.append($("<option>").text(dishes[i]));mailSelect.append($("<option>").text("HELP"))}function render(text,env){for(var re=/\$\(([^)\n]*)\)/;;){var match=text.match(re);if(!match)break;var varName=match[1];if(void 0===env[varName])return["unknown variable "+varName,null];text=text.replace(match[0],""+env[varName])}return[null,text]}function onSelectMail(event){var value=$(event.target).val();selected=value,editorUpdate()}function editorUpdate(){locked=!0,setTimeout(function(){locked=!1},1e3),null===selected?mailEditor.val():"HELP"===selected?(mailEditor.val(defaults.mailsHelp()),mailEditor.prop("disabled",!0)):(mailEditor.val(mails.getMail(selected)),mailEditor.prop("disabled",!1))}function insertFields(target,obj,map,prefix){prefix=prefix||"";for(var key in map)target[prefix+map[key]]=obj[key]}function onInit(elem){view=elem;var container=$("<div>").attr("id","mail-container"),ctrlPanel=$("<div>").attr("id","mail-ctrl");mailSelect=$("<select>").attr("id","mail-select");var spacer=$("<div>").addClass("spacer"),userLabel=$("<span>").text("user").addClass("label");userEdit=$("<input>").attr("id","mail-user");var passLabel=$("<span>").text("pass").addClass("label");passEdit=$("<input>").attr("id","mail-pass").attr("type","password");var download=$("<button>").text("Download Mails"),send=$("<button>").text("Send Mails");mailEditor=$("<textarea>").attr("id","mail-editor"),container.append(ctrlPanel),ctrlPanel.append(mailSelect),ctrlPanel.append(spacer),ctrlPanel.append(userLabel),ctrlPanel.append(userEdit),ctrlPanel.append(passLabel),ctrlPanel.append(passEdit),ctrlPanel.append(download),ctrlPanel.append(send),container.append(mailEditor),mailSelect.on("change",onSelectMail),updateOptions(mails.getTypes()),mailEditor.on("input",delayedOnce.make(function(event){locked||null===selected||"HELP"===selected||(locked=!0,mails.setMail(selected,mailEditor.val()),locked=!1)},.25)),download.on("click",function(){var _bestMatching$get=bestMatching.get(),config=_bestMatching$get.config,match=_bestMatching$get.match;if(null===config)return void sig.emit("error","no matching");for(var teamsList=teamsModel.getAll(),teams={},i=0;i<teamsList.length;++i)teams[teamsList[i].id]=teamsList[i];for(var fullMatching=matching.asFull(config,match),mailBuf=[],dishes=defaults.dishes(),dish=0;dish<dishes.length;++dish)for(var mailTemplate=mails.getMail(dishes[dish]),_i10=0;_i10<fullMatching.length;++_i10){var team=teamsList[_i10];if(fullMatching[_i10].cooking===dishes[dish]){var env={};insertFields(env,team,{cook1name:"recipientFirst1",cook1last:"recipientLast1",cook2name:"recipientFirst2",cook2last:"recipientLast2"});for(var dish2=0;dish2<dishes.length;++dish2){var dishName=dishes[dish2],cooks=teams[fullMatching[_i10][dishName][0]];insertFields(env,cooks,{cook1name:"CookFirst1",cook1last:"CookLast1",cook2name:"CookFirst2",cook2last:"CookLast2",address:"CookAddress",phone:"CookPhone",comments:"CookComments"},dishName);var guest1=teams[fullMatching[_i10][dishName][1]];insertFields(env,guest1,{cook1name:"Guest1First1",cook1last:"Guest1Last1",cook2name:"Guest1First2",cook2last:"Guest1Last2",phone:"Guest1Phone",comments:"Guest1Comments"},dishName);var guest2=teams[fullMatching[_i10][dishName][2]];insertFields(env,guest2,{cook1name:"Guest2First1",cook1last:"Guest2Last1",cook2name:"Guest2First2",cook2last:"Guest2Last2",phone:"Guest2Phone",comments:"Guest2Comments"},dishName)}var _render=render(mailTemplate,env),_render2=_slicedToArray(_render,2),err=_render2[0],mail=_render2[1];if(err)return void sig.emit("error",err);mailBuf.push(team.cook1mail+", "+team.cook2mail),mailBuf.push("*******************************************************"),mailBuf.push(mail),mailBuf.push("*******************************************************"),mailBuf.push("*******************************************************"),mailBuf.push("")}}downloadFile("mails-matched.txt",mailBuf.join("\n"))}),sig.on("mails-modified",function(){editorUpdate()}),selected="starter",view.append(container)}var view=null,userEdit=null,passEdit=null,mailSelect=null,mailEditor=null,selected=null,locked=!1,downloadFile=function(filename,contents){var href="data:text/plain;utf-8,"+encodeURI(contents),link=document.createElement("a");link.href=href,link.download=filename,link.click()};return{onInit:onInit}}(),vMap=function(){function searchRebuild(){for(var teams=teamsModel.getAll(),directory=[],i=0;i<teams.length;++i)directory[i]={id:teams[i].id,names:teams[i].cook1name+" "+teams[i].cook1last+", "+teams[i].cook2name+" "+teams[i].cook2last,address:""+teams[i].address};fuse=new Fuse(directory,{keys:["id","names","address"],caseSensitive:!1,tokenize:!0})}function searchOnInput(event){if(null!==fuse){var query=$(event.target).val().trim(),hits=fuse.search(query);if(""===query||hits.length<1)searchHighlight=null,searchResult.text(""),searchResult.attr("title","");else{searchHighlight=hits[0].id;var team=teamsModel.getOne(hits[0].id);searchResult.text(hits[0].names),searchResult.attr("title",team.address),mapModel.isWithinBounds(team.lat,team.lng)?searchResult.removeClass("too-far"):searchResult.addClass("too-far")}markersUpdate()}}function markerOnMouseEnter(e){var info=e.target.options.custom;mouseHighlight=info.teamId,markersUpdate()}function markerOnMouseLeave(e){mouseHighlight=null,markersUpdate()}function markerOnDragStart(e){var info=e.target.options.custom,_e$target$getLatLng=e.target.getLatLng(),lat=_e$target$getLatLng.lat,lng=_e$target$getLatLng.lng;info.origLatLng={lat:lat,lng:lng}}function markerOnDragEnd(e){var info=e.target.options.custom,_e$target$getLatLng2=e.target.getLatLng(),lat=_e$target$getLatLng2.lat,lng=_e$target$getLatLng2.lng,_info$origLatLng=info.origLatLng,origLat=_info$origLatLng.lat,origLng=_info$origLatLng.lng;info.origLatLng=void 0;var teamId=info.teamId;undoAdd(teamId,origLat,origLng),teamsModel.updateRow({id:info.teamId,lat:lat,lng:lng})}function markersUpdate(){for(var teamId in markers){var marker=markers[teamId];teamId==mouseHighlight||teamId==searchHighlight?(marker.setOpacity(1),marker._icon.innerHTML=marker.options.custom.fullText):(marker.setOpacity(.6),marker._icon.innerHTML=marker.options.custom.teamId)}}function markersRebuild(){for(var teamId in markers){var marker=markers[teamId];mapControl.removeLayer(marker)}markers={};for(var teams=teamsModel.getAll(),i=0;i<teams.length;++i){var team=teams[i];if(null!==team.lat&&null!==team.lng){var icon=L.divIcon({className:"map-marker-icon",iconSize:L.Point(8,8),html:team.id}),_marker=L.marker([team.lat,team.lng],{icon:icon,draggable:!0,riseOnHover:!0,opacity:.6,custom:{teamId:team.id,fullText:team.cook1name+" "+team.cook1last+", "+team.address,dragging:!1}});markers[team.id]=_marker,_marker.on("mouseover",markerOnMouseEnter),_marker.on("mouseout",markerOnMouseLeave),_marker.on("dragstart",markerOnDragStart),_marker.on("dragend",markerOnDragEnd),_marker.addTo(mapControl)}}}function undoUpdate(){0==history.length?undoBtn.prop("disabled",!0):undoBtn.prop("disabled",!1)}function undoOnClick(){if(0!=history.length){var _history$splice$=_slicedToArray(history.splice(-1)[0],3),teamId=_history$splice$[0],lat=_history$splice$[1],lng=_history$splice$[2];console.log("resetting "+teamId+" to "+lat+", "+lng),teamsModel.updateRow({id:teamId,lat:lat,lng:lng}),markersRebuild(),undoUpdate()}}function undoAdd(team,lat,lng){history[history.length]=[team,lat,lng],console.log(history),undoUpdate()}function onInit(elem){view=elem;var container=$("<div>").attr("id","map-container"),searchContainer=$("<div>").attr("id","map-search-container"),searchLabel=$("<div>").attr("id","map-search-label").text("find");search=$("<input>").attr("id","map-search"),searchResult=$("<div>").attr("id","map-search-result"),map=$("<div>").attr("id","map-leaflet"),undoBtn=$("<button>").attr("id","map-undo").text("undo"),container.append(searchContainer),searchContainer.append(searchLabel),searchContainer.append(search),searchContainer.append(searchResult),container.append(map),container.append(undoBtn),view.append(container),map.resize(function(){map.css({width:"100%",height:map.parent().height()-30+"px"}),mapControl.invalidateSize()});var bounds=mapModel.getBounds(),center=[(bounds[0]+bounds[2])/2,(bounds[1]+bounds[3])/2];mapControl=L.map("map-leaflet",{center:center,zoom:13}),L.tileLayer("http://a.tile.osm.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'}).addTo(mapControl);var delayedOnTeamsChanged=delayedOnce.make(function(){searchRebuild(),markersRebuild(),undoUpdate()},.5);sig.on("teams-modified",delayedOnTeamsChanged),undoBtn.on("click",undoOnClick),search.on("keydown",function(event){"Escape"===event.key&&(search.val(""),searchOnInput(event))}),search.on("input",delayedOnce.make(function(event){searchOnInput(event)},.2))}function onActivate(){}var view=null,map=null,search=null,searchResult=null,undoBtn=null,mapControl=null,markers={},searchHighlight=null,mouseHighlight=null,fuse=null,history=[];return{onInit:onInit,onActivate:onActivate}}(),bestMatching=function(){function set(_config,_match,_score){config=_config,match=_match,score=_score,sig.emit("bestMatching-modified")}function get(){return{config:config,match:match,score:score}}function reset(){config=null,match=null,score=null}function serialize(){return JSON.stringify({config:config,match:match,score:score})}function deserialize(raw){var parsed=JSON.parse(raw),_config=parsed.config,_match=parsed.match,_score=parsed.score;config=_config,match=_match,score=_score,sig.emit("bestMatching-modified")}var config=null,match=null,score=null;return{reset:reset,serialize:serialize,deserialize:deserialize,set:set,get:get}}(),vMatching=function(){function newMatching(){var teams=teamsModel.getAll(),dishes=defaults.dishes();if(0===teams.length)return sig.emit("error","no teams"),void updateUI();var _matching$makeConfig=matching.makeConfig(teams,dishes),_matching$makeConfig2=_slicedToArray(_matching$makeConfig,2),err=_matching$makeConfig2[0],tryConfig=_matching$makeConfig2[1];if(err)return sig.emit("error",err),void updateUI();var source=rulesModel.get(),tryRules=void 0,_matching$parseConstr=matching.parseConstraints(source),_matching$parseConstr2=_slicedToArray(_matching$parseConstr,2);if(err=_matching$parseConstr2[0],tryRules=_matching$parseConstr2[1],err.length>0)return sig.emit("error","errors in rules"),void updateUI();var errors=matching.checkConstraints(teams,dishes,tryRules);return errors.length>0?(sig.emit("error","errors in rules"),void updateUI()):(config=tryConfig,rules=tryRules,match=matching.initialMatch(config,rules),score=matching.score(config,rules,match),void bestMatching.set(config,match,score))}function updateUI(){updateButtons(),updateData(),updateLabels()}function updateButtons(){var bState=workerControl();"idle"===bState&&null!==match?(buttonImprove.text("improve"),buttonImprove.prop("disabled",!1)):"idle"===bState&&null===match?(buttonImprove.text("..."),buttonImprove.prop("disabled",!0)):"starting"===bState?(buttonImprove.text("..."),buttonImprove.prop("disabled",!0)):"active"===bState?(buttonImprove.text("stop"),buttonImprove.prop("disabled",!1)):"stopping"===bState&&(buttonImprove.text("..."),buttonImprove.prop("disabled",!0))}function updateLabels(){null!==score?labelScore.text("cost: "+score.total.toFixed(2)):labelScore.text("cost: N/A"),null!==score&&score.total>1e3?labelScore.addClass("outdated"):labelScore.removeClass("outdated");null===config?(labelState.text("state: empty"),labelState.removeClass("outdated")):outdated?(labelState.text("state: outdated"),labelState.addClass("outdated")):(labelState.text("state: good"),labelState.removeClass("outdated"))}function updateData(){var _bestMatching$get2=bestMatching.get(),config=_bestMatching$get2.config,match=_bestMatching$get2.match,dishes=defaults.dishes();if(null!==config&&null!==match)if(showAddress){for(var long=matching.asLong(config,match),_teams2=teamsModel.getAll(),list=[],i=0;i<long.length;++i){var row={};row.teamId=_teams2[i].id,row.cooking=dishes[long[i][0]];var starter=long[i][1];row.starter=_teams2[starter].id+", "+_teams2[starter].address;var main=long[i][2];row.main=_teams2[main].id+", "+_teams2[main].address;var dessert=long[i][3];row.dessert=_teams2[dessert].id+", "+_teams2[dessert].address,list[list.length]=row}table.egrid({data:list})}else{var _list=matching.asList(config,match);table.egrid({data:_list})}else table.egrid({data:[]});void 0!==score&&null!==score?labelScore.text("score: "+score.total.toFixed(2)):labelScore.text("score: N/A")}function onInit(elem){view=elem;var container=$("<div>").attr("id","match-container"),controls=$("<div>").attr("id","match-controls"),buttonStart=$("<button>").attr("id","match-start").text("start matching");buttonImprove=$("<button>").text("improve").prop("disabled",!0);var buttonSwitchTable=$("<button>").text("show addresses"),labels=$("<div>").attr("id","match-labels");labelState=$("<div>").attr("id","match-state").text("state: empty"),labelScore=$("<div>").attr("id","match-score").text("cost: N/A"),table=$("<div>").attr("id","match-table"),table.egrid({columns:[{title:"Team",id:"teamId",editable:!1},{title:"Cooking",id:"cooking",editable:!1},{title:"Starter",id:"starter",editable:!1},{title:"Main",id:"main",editable:!1},{title:"Dessert",id:"dessert",editable:!1}]}),container.append(controls),controls.append(buttonStart),controls.append(buttonImprove),controls.append(buttonSwitchTable),container.append(labels),labels.append(labelState),labels.append(labelScore),container.append(table),buttonImprove.css("width","80px"),buttonSwitchTable.css("width","130px"),buttonStart.on("click",function(event){newMatching()}),buttonImprove.on("click",function(event){var state=workerControl();"idle"===state&&workerControl("start"),"active"===state&&workerControl("stop"),updateButtons()}),buttonSwitchTable.on("click",function(event){showAddress?(showAddress=!1,buttonSwitchTable.text("show addresses")):(showAddress=!0,buttonSwitchTable.text("hide addresses")),updateData()}),sig.on("teams-modified",function(){outdated=!0,updateUI()}),sig.on("rules-modified",function(){outdated=!0,updateUI()}),sig.on("bestMatching-modified",function(){var best=bestMatching.get();config=best.config,match=best.match,score=best.score,outdated=!1,updateUI()}),view.append(container),updateUI()}function onActivate(){}var labelState=null,labelScore=null,table=null,config=null,match=null,rules=null,score=null,showAddress=!1,outdated=!1,buttonImprove=void 0,view=null,workerControl=function(){function workerOnMessage(event){var msg=event.data;"started"===msg.action&&(fsm("started"),updateUI()),"update"===msg.action&&(fsm("update",msg),updateUI()),"stopped"===msg.action&&(fsm("stopped"),updateUI())}function workerOnError(event){console.error(event)}function dirname(path){return path.match(/.*\//)}var worker=null,combinations=0,fsm=stateMachine("idle",[{from:["idle"],symbol:"start",to:"starting",action:function(){var blob=new Blob([workerCode],{type:"text/javascript"}),objectUrl=window.URL.createObjectURL(blob);worker=new Worker(objectUrl);var _bestMatching$get3=bestMatching.get(),config=_bestMatching$get3.config,match=_bestMatching$get3.match;worker.onmessage=workerOnMessage,worker.onerror=workerOnError,worker.postMessage({action:"start",config:config,imports:[document.location.protocol+"//"+dirname(document.location.pathname)+"/workerdeps.min.js"],match:match,rules:rules,n:200}),sig.emit("loading-started")}},{from:["starting"],symbol:"started",to:"active",action:function(){}},{from:["active"],symbol:"update",to:"active",action:function(data){data.score.total<score.total&&(score=data.score,match=data.match,combinations=data.tried,bestMatching.set(config,match,score)),worker.postMessage({action:"continue"})}},{from:["active"],symbol:"stop",to:"stopping",action:function(){worker.postMessage({action:"stop"})}},{from:["stopping"],symbol:"update",to:"stopping",action:function(){}},{from:["stopping"],symbol:"stopped",to:"idle",action:function(){sig.emit("loading-stopped"),console.log("tried "+combinations+" combinations")}}]);return fsm}();return{onInit:onInit,onActivate:onActivate}}(),vRules=function(){function lock(){locked=!0}function unlock(){locked=!1}function updateAll(){lock(),editor.val(rulesModel.get()),unlock(),overlayControl.updateErrors()}function onInit(elem){view=elem;var container=$("<div>").attr("id","rules-container"),editorDiv=$("<div>").attr("id","rules-editor");overlay=$("<div>").attr("id","rules-editor-overlay"),editor=$("<textarea>").attr("id","rules-editor-edit");var help=$("<div>").attr("id","rules-help").html(defaults.rulesHelp());container.append(editorDiv),editorDiv.append(overlay),editorDiv.append(editor),container.append(help),editor.on("scroll",function(event){overlay.prop("scrollTop",editor.prop("scrollTop"))}),editor.on("mousemove",delayedOnce.make(function(event){var lineHeight=parseInt(editor.css("line-height"),10),line=Math.floor(event.offsetY/lineHeight);overlayControl.updateMessage(line)},.05)),editor.on("input",delayedOnce.make(function(event){overlayControl.updateErrors(),locked||rulesModel.set(editor.val())},.25)),sig.on("rules-modified",function(){locked=!0,editor.val(rulesModel.get()),locked=!1}),overlayControl.init(overlay,editor),locked=!0,editor.val(rulesModel.get()),locked=!1,view.append(container)}function onActivate(){updateAll()}var view=null,editor=null,overlay=null,locked=!1,overlayControl=function(){function init(_overlay,_editor){overlay=_overlay,editor=_editor,message=$("<div>").addClass("message")}function updateMessage(line){void 0!==errors[line]?(message.text(errors[line]),message.css({display:"block",left:"1px",top:line*lineHeight+lineHeight+"px"}),overlay.append(message)):message.css("display","none")}function updateErrors(){var source=editor.val(),teams=teamsModel.getAll(),dishes=["starter","main","dessert"];lineHeight=parseInt(editor.css("line-height"),10),errors={};for(var _matching$parseConstr3=matching.parseConstraints(source),_matching$parseConstr4=_slicedToArray(_matching$parseConstr3,2),errSyn=_matching$parseConstr4[0],cns=_matching$parseConstr4[1],i=0;i<errSyn.length;++i)errors[errSyn[i][0]-1]=errSyn[i][1];for(var errCn=matching.checkConstraints(teams,dishes,cns),_i11=0;_i11<errCn.length;++_i11){var cn=cns[errCn[_i11][0]];errors[cn.line-1]=errCn[_i11][1]}lineHeight=parseInt(editor.css("line-height"),10),overlay.empty();for(var line in errors){var _bar=$("<div>").addClass("error");_bar.css({left:0,top:line*lineHeight+"px"}),overlay.append(_bar)}}var overlay=void 0,editor=void 0,errors={},message=void 0,lineHeight=0;return{init:init,updateErrors:updateErrors,updateMessage:updateMessage}}();return{onInit:onInit,onActivate:onActivate}}(),vTeams=function(){function onChangedColumns(choices){void 0===choices&&(choices={cook1:!0,cook2:!0,info:!0,comments:!1,coords:!0}),columns=[{title:"ID",id:"id",editable:!1,width:"60px",class:"team-id"}],choices.cook1&&(columns=columns.concat([{title:"Name 1",id:"cook1name"},{title:"Last 1",id:"cook1last"},{title:"Mail 1",id:"cook1mail"}])),choices.cook2&&(columns=columns.concat([{title:"Name 2",id:"cook2name"},{title:"Last 2",id:"cook2last"},{title:"Mail 2",id:"cook2mail"}])),choices.info&&(columns=columns.concat([{title:"Address",id:"address"},{title:"Phone",id:"phone"}])),choices.comments&&columns.push({title:"Comments",id:"comments"}),choices.coords&&(columns=columns.concat([{title:"Lat.",id:"lat",width:"40px"},{title:"Lng.",id:"lng",width:"40px"}])),updateTable()}function updateTable(){updating&&teamTable.egrid({columns:columns,data:pending.concat(teamsModel.getAll())})}function onStartEdit(){updating=!1}function onEndEdit(){updating=!0}function onEdited(row){var pendingIdx=row.pending;if(""!==row.id)(""===row.lat||isNaN(row.lat))&&(row.lat=void 0),(""===row.lng||isNaN(row.lng))&&(row.lng=void 0),teamsModel.updateRow(row);else{teamsModel.lockModified();var _teamsModel$addRow=teamsModel.addRow(row),_teamsModel$addRow2=_slicedToArray(_teamsModel$addRow,2),newId=_teamsModel$addRow2[0];_teamsModel$addRow2[1];if(newId!==!1)for(var i=0;i<pending.length;++i)pending[i].pending==pendingIdx&&pending.splice(i,1);else for(var _i12=0;_i12<pending.length;++_i12)pending[_i12].pending==pendingIdx&&(pending[_i12]=row);teamsModel.unlockModified()}}function onStyleRow(row){var style={};""!==row.pending&&(style.row="pending-row");var _ref3=[parseFloat(row.lat),parseFloat(row.lng)],lat=_ref3[0],lng=_ref3[1];return""!=row.pending||mapModel.isWithinBounds(lat,lng)||(style.lat="too-far",style.lng="too-far"),style}function onGeocodeStart(number){return!(geoInflight>0)&&(teamsModel.lockModified(),sig.emit("loading-start"),void(geoInflight=number))}function onGeocodeTick(){geoInflight--,0===geoInflight&&onGeocodeDone()}function onGeocodeDone(){teamsModel.unlockModified(),sig.emit("loading-stop")}function onActivate(){teamTable.egrid("refresh")}function onInit(elem){view=elem;var teamContainer=$("<div>").attr("id","team-container"),controls=$("<div>").attr("id","team-controls"),buttonAdd=$("<button>").attr("id","team-add").text("add team"),buttonClear=$("<button>").attr("id","team-clear").text("delete all"),buttonLocs=$("<button>").attr("id","team-locs").text("resolve addresses"),buttonColumns=$("<button>").attr("id","team-columns").text("columns");teamTable=$("<div>").attr("id","team-table"),teamContainer.append(controls),controls.append(buttonAdd),controls.append(buttonClear),controls.append(buttonLocs),controls.append(buttonColumns),teamContainer.append(teamTable),
buttonLocs.on("click",function(event){var rows=teamsModel.get(),nrows=(mapModel.getBounds(),rows.length);onGeocodeStart(nrows);for(var delayedUpdate=delayedOnce.make(function(){updateTable()},.5),_loop2=function(i){var row=rows[i];geo.code(row.address,function(err,results){onGeocodeTick(),err||(teamsModel.updateRow({id:row.id,lat:results[0].lat,lng:results[0].lng}),delayedUpdate())})},i=0;i<nrows;++i)_loop2(i)}),buttonAdd.on("click",function(event){var newRow={pending:"pending"+pendingIdx};pendingIdx+=1,pending[pending.length]=newRow,updateTable()}),buttonClear.on("click",function(event){teamsModel.clear()}),buttonColumns.dropdownmulti([["First cook","cook1",!0],["Second cook","cook2",!0],["Contact info","info",!0],["Comments","comments",!1],["Coordinates","coords",!0]],{onStartEdit:onStartEdit,onChanged:function(choices){onChangedColumns(choices)},onEndEdit:onEndEdit}),view.append(teamContainer),onChangedColumns(),teamTable.egrid({columns:columns,extraFields:["pending"],onStyleRow:onStyleRow,onEdited:onEdited}),sig.on("teams-modified",function(){updateTable()})}var view=null,teamTable=null,pendingIdx=0,pending=[],updating=!0,columns=null,geoInflight=void 0;return{onInit:onInit,onActivate:onActivate}}(),vFooter=function(){function init(elem){dom=elem,numTeams=$("<div>").text("Teams: "+teamsModel.getNumber()),elem.append(numTeams),sig.on("*-modified",onModifiedAny),sig.on("all-saved",onSavedAll),sig.on("all-loaded",onLoadedAll),sig.on("error",onSignalError)}function onModifiedAny(){numTeams.text("Teams: "+teamsModel.getNumber()),null!==dom&&null===modified&&(modified=$("<div>").addClass("warning").text("unsaved changes"),dom.append(modified),$(modified).fadeIn(300))}function onSavedAll(){null!==dom&&null!==modified&&($(modified).fadeOut(300),modified=null)}function onLoadedAll(){numTeams.text("Teams: "+teamsModel.getNumber()),null!==dom&&null!==modified&&($(modified).fadeOut(300),modified=null)}function onSignalError(msg){var elem=$("<div>").addClass("error").text(msg);dom.append(elem),setTimeout(function(){elem.fadeOut(500)},5e3)}var dom=null,modified=null,numTeams=null;return{init:init}}(),vLoading=function(){function init(elem){view=$(elem),view.addClass("sk-cube-grid");for(var i=1;i<10;++i){var div=$("<div>").addClass("sk-cube").addClass("sk-cube"+i);view.append(div)}view.css("display","none")}var view=null;return sig.on("loading-start",function(){view.css("display","block")}),sig.on("loading-stop",function(){view.css("display","none")}),{init:init}}(),vDb=function(){function onTeamImport(file){withContents(file,function(contents){var _csv$fromString=csv.fromString(contents,{quote:'"',separator:",",requiredFields:["cook1name","cook1last","cook1mail","cook2name","cook2last","cook2mail","address","phone"],hasHeader:!0}),_csv$fromString2=_slicedToArray(_csv$fromString,2),err=_csv$fromString2[0],rows=_csv$fromString2[1];if(err)return void sig.emit("error",err);teamsModel.lockModified(),teamsModel.clear();for(var i=0;i<rows.length;++i)teamsModel.addRow(rows[i]);teamsModel.unlockModified()})}function onTeamExport(){var teams=teamsModel.getAll(),_csv$toString=csv.toString(teams,{fields:["cook1name","cook1last","cook1mail","cook2name","cook2last","cook2mail","address","phone","comments","lat","lng"],separator:",",quote:'"',hasHeader:!0}),_csv$toString2=_slicedToArray(_csv$toString,2),err=_csv$toString2[0],str=_csv$toString2[1];return err?void console.error(err):void downloadFile("teams.csv",str)}function onConstraintImport(file){withContents(file,function(contents){rulesModel.deserialize(contents)})}function onConstraintExport(){downloadFile("rules.txt",rulesModel.get())}function onMatchingImport(file){withContents(file,function(contents){bestMatching.deserialize(contents)})}function onMatchingExportCustom(){downloadFile("matching.json",bestMatching.serialize())}function onMatchingExportCsv(){for(var teamList=teamsModel.getAll(),teams={},i=0;i<teamList.length;++i)teams[teamList[i].id]=teamList[i];for(var _bestMatching$get4=bestMatching.get(),config=_bestMatching$get4.config,match=_bestMatching$get4.match,list=matching.asList(config,match),fields=["teamNames","teamCooks","starterCookNames","starterCookAddress","starterCookPhone","mainCookNames","mainCookAddress","mainCookPhone","dessertCookNames","dessertCookAddress","dessertCookPhone"],rows=[],_i13=0;_i13<list.length;++_i13){var _row3={},team=teamList[_i13];_row3.teamNames=team.cook1name+" "+team.cook1last+", "+team.cook2name+" "+team.cook2last,_row3.teamCooks=list[_i13].cooking;var starter=teams[list[_i13].starter];_row3.starterCookNames=starter.cook1name+" "+starter.cook1last+", "+starter.cook2name+" "+starter.cook2last,_row3.starterCookAddress=""+starter.address,_row3.starterCookPhone=""+starter.phone;var main=teams[list[_i13].main];_row3.mainCookNames=main.cook1name+" "+main.cook1last+", "+main.cook2name+" "+main.cook2last,_row3.mainCookAddress=""+main.address,_row3.mainCookPhone=""+main.phone;var dessert=teams[list[_i13].dessert];_row3.dessertCookNames=dessert.cook1name+" "+dessert.cook1last+", "+dessert.cook2name+" "+dessert.cook2last,_row3.dessertCookAddress=""+dessert.address,_row3.dessertCookPhone=""+dessert.phone,rows.push(_row3)}var options={fields:fields,hasHeader:!0,quote:'"',separator:","},_csv$toString3=csv.toString(rows,options),_csv$toString4=_slicedToArray(_csv$toString3,2),err=_csv$toString4[0],raw=_csv$toString4[1];return err?void sig.emit("error",err):void downloadFile("matching.csv",raw)}function onMailImport(file){withContents(file,function(contents){mails.deserialize(contents)})}function onMailExport(){downloadFile("mails.json",mails.serialize())}function onInit(elem){view=elem;var dom=$.parseHTML('\n    <div id="db-container">\n      <div class="db-section">Teams</div>\n      <div id="db-team-drop" class="db-drop">drop to import (csv)</div>\n      <button id="db-team-export">download (csv)</button>\n\n      <div class="db-section">Rules</div>\n      <div id="db-constraint-drop" class="db-drop">drop to import (text file)</div>\n      <button id="db-constraint-export">download (text file)</button>\n\n      <div class="db-section">Matching</div>\n      <div id="db-matching-drop" class="db-drop">drop to import (custom)</div>\n      <button id="db-matching-export-custom">download (custom)</button>\n      <button id="db-matching-export-csv">download (csv)</button>\n\n      <div class="db-section">Mails</div>\n      <div id="db-mail-drop" class="db-drop">drop to import (custom)</div>\n      <button id="db-mail-export">download (custom)</button>\n\n      <div class="db-section">Other</div>\n      <button id=\'db-clear-cache\'>clear everything</button>\n    </div>\n    ');$(dom).find("#db-team-drop").droppable(onTeamImport),$(dom).find("#db-team-export").on("click",onTeamExport),$(dom).find("#db-constraint-drop").droppable(onConstraintImport),$(dom).find("#db-constraint-export").on("click",onConstraintExport),$(dom).find("#db-matching-drop").droppable(onMatchingImport),$(dom).find("#db-matching-export-custom").on("click",onMatchingExportCustom),$(dom).find("#db-matching-export-csv").on("click",onMatchingExportCsv),$(dom).find("#db-mail-drop").droppable(onMailImport),$(dom).find("#db-mail-export").on("click",onMailExport),$(dom).find("#db-clear-cache").on("click",function(){geo.clearCache(),persistence.clear()}),view.append(dom)}var view=null,withContents=function(file,fn){var reader=new FileReader;reader.onload=function(theFile){return function(e){return fn(e.target.result)}}(file),reader.readAsText(file,"utf8")},downloadFile=function(filename,contents){var href="data:text/plain;charset=utf-8,"+encodeURIComponent(contents),link=document.createElement("a");link.href=href,link.download=filename,link.click()};return{onInit:onInit}}(),workerCode=function(){return"\n\"use strict\";\n\nlet config;\nlet bestMatch;\nlet bestScore;\nlet rules;\nlet n;\nlet tried = 0;\n\nfunction bestOf(config, match, rules, n) {\n  bestMatch = match;\n  bestScore = matching.score(config, rules, match);\n  for (let i = 0; i < n; ++i) {\n    let attempt = matching.shuffleMatch(config, match, [2, 0.125], [10, 0.2]);\n    let score = matching.score(config, rules, attempt);\n    if (score.total < bestScore.total) {\n      bestMatch = attempt;\n      bestScore = score;\n    }\n    tried += 1;\n  }\n  postMessage({\n    action: 'update',\n    score: bestScore,\n    match: bestMatch,\n    tried: tried,\n  })\n}\n\nself.addEventListener('message', function(e) {\n  let msg = e.data;\n  if (msg.action === 'start') {\n    n = msg.n;\n    rules = msg.rules;\n    config = msg.config;\n    let imports = msg.imports;\n\n    /* WEIRD HACK TO AVOID CROSS ORIGIN ISSUES */\n    for (let i = 0; i < imports.length; ++i) {\n      importScripts(imports[i]);\n    }\n\n    let match = msg.match;\n    postMessage({\n      action: 'started',\n    })\n    bestOf(config, match, rules, n);\n  }\n  if (msg.action === 'continue') {\n    bestOf(config, bestMatch, rules, n);\n  }\n  if (msg.action === 'stop') {\n    postMessage({\n      action: 'stopped',\n    })\n    close();\n  }\n}, false);\n\n"}();
