<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>VISUM Running Dinner Matching</title>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700" rel="stylesheet">
    <!-- libraries -->
    <script type="text/javascript" src="lib/jquery-3.1.1.min.js"></script>
    <script type="text/javascript" src="lib/core-estimator.js"></script>
    <script type="text/javascript" src="lib/jquery.resize.js"></script>
    <script type="text/javascript" src="lib/key-polyfill.js"></script>
    <script type="text/javascript" src="lib/fuse.min.js"></script>
    <script type="text/javascript" src="lib/emailjs.min.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.2/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.0.2/dist/leaflet.js"></script>

    <!-- app -->
    <link type="text/css" rel="stylesheet" href="app.css"/>
    <script type="text/javascript" src="app.min.js"></script>
    <script type="text/plain" id="workercode">// Copyright (c) 2016, Alexander Matz
// All rights reserved.
// 
// Redistribution and use in source and binary forms, with or without modification,
// are permitted provided that the following conditions are met:
// 
// 1. Redistributions of source code must retain the above copyright notice, this
//    list of conditions and the following disclaimer.
// 
// 2. Redistributions in binary form must reproduce the above copyright notice,
//    this list of conditions and the following disclaimer in the documentation
//    and/or other materials provided with the distribution.
// 
// THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
// ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
// WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
// DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR
// ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
// (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
// LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
// ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
// (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
// SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
// *****************************************************************
"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_slicedToArray=function(){function sliceIterator(arr,i){var _arr=[],_n=!0,_d=!1,_e=void 0;try{for(var _s,_i=arr[Symbol.iterator]();!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{!_n&&_i["return"]&&_i["return"]()}finally{if(_d)throw _e}}return _arr}return function(arr,i){if(Array.isArray(arr))return arr;if(Symbol.iterator in Object(arr))return sliceIterator(arr,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),calcCrow=function(p1,p2){function toRad(Value){return Value*Math.PI/180}var _p=_slicedToArray(p1,2),_lat1=_p[0],lon1=_p[1],_p2=_slicedToArray(p2,2),_lat2=_p2[0],lon2=_p2[1],R=6371,dLat=toRad(_lat2-_lat1),dLon=toRad(lon2-lon1),lat1=toRad(_lat1),lat2=toRad(_lat2),a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.sin(dLon/2)*Math.sin(dLon/2)*Math.cos(lat1)*Math.cos(lat2),c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)),d=R*c;return d},cursor3d=function(data,nx,ny){return function(x,y,z,val){var idx=0;return idx+=x,idx+=y*nx,idx+=z*nx*ny,void 0===val?data[idx]:void(data[idx]=val)}},randomSet=function(){function _del(set,val){if(void 0===set[val])throw"element not in set!";delete set[val]}function _has(set,val){return set[val]===!0}function _add(set,val){if(set[val]===!0)throw"element already in set!";set[val]=!0}function _get(set){return Object.keys(set)}function _pick(set){if(0==Object.keys(set).length)throw"trying to pick/pop from empty set";var keys=Object.keys(set),val=keys[keys.length*Math.random()<<0];return val}function _pop(set){var val=_pick(set);return _del(set,val),val}function augment(obj){return{has:function(val){return _has(obj,val)},get:function(){return _get(obj)},add:function(val){return _add(obj,val)},del:function(val){return _del(obj,val)},pick:function(){return _pick(obj)},pop:function(){return _pop(obj)}}}function fromArray(arr){if("object"!==("undefined"==typeof arr?"undefined":_typeof(arr)))throw"expected array as argument";for(var set={},i=0;i<arr.length;++i){if("object"===_typeof(arr[i]))throw"cannot use objects as keys";set[arr[i]]=!0}return augment(set)}function fromRange(min,max){for(var set={},i=0;max>i;++i)set[i]=!0;return augment(set)}function fromEmpty(){return augment({})}return{fromArray:fromArray,fromRange:fromRange,fromEmpty:fromEmpty}}(),matching=function(){function makeConfig(_teams,_dishes){var nteams=_teams.length,ndishes=_dishes.length,ngroups=nteams/ndishes;if(nteams%ndishes!=0)return["number of teams ("+nteams+") not divisable by number of dishes ("+ndishes+")!",null];for(var teams=[],i=0;nteams>i;++i)teams.push({id:_teams[i].id,lat:_teams[i].lat,lng:_teams[i].lng});var dishes=_dishes.slice();return[null,{nteams:nteams,ndishes:ndishes,ngroups:ngroups,teams:teams,dishes:dishes}]}function initialMatch(config){for(var nteams=config.nteams,ndishes=config.ndishes,ngroups=config.ngroups,availCooks=(config.assignments,randomSet.fromRange(0,nteams)),match={nx:ndishes,ny:ngroups,nz:ndishes,data:[]},nx=ndishes,ny=ngroups,nz=ndishes,arr=match.data,i=0;nx*ny*nz>i;++i)arr[i]=-1;for(var val=cursor3d(arr,nx,ny,nz),_i=0;ndishes>_i;++_i){for(var availGuests=randomSet.fromRange(0,nteams),j=0;ngroups>j;++j){var cook=parseInt(availCooks.pop());availGuests.del(cook),val(_i,j,0,cook)}for(var _j=0;ngroups>_j;++_j)for(var k=1;ndishes>k;++k){var guest=parseInt(availGuests.pop());val(_i,_j,k,guest)}}return match}function shuffleMatch(config,match,tsProb,ssProb){match={nx:match.nx,ny:match.ny,nz:match.nz,data:match.data.slice()};var val=cursor3d(match.data,match.nx,match.ny,match.nz),nteams=config.nteams,ndishes=config.ndishes,ngroups=config.ngroups;if(isNaN(tsProb[0])||isNaN(tsProb[1])||isNaN(ssProb[0])||isNaN(ssProb[1]))throw"bad probabilities";for(var _tsProb=_slicedToArray(tsProb,2),rolls=_tsProb[0],chance=_tsProb[1],_=0;rolls>_;++_)if(!(Math.random()>chance)){for(var team1=nteams*Math.random()<<0,team2=nteams*Math.random()<<0;team2===team1;)team2=nteams*Math.random()<<0;for(var team1List=[],team2List=[],dish=0;ndishes>dish;++dish)for(var group=0;ngroups>group;++group)for(var seat=0;ndishes>seat;++seat)val(dish,group,seat)===team1&&(team1List[team1List.length]=[dish,group,seat]),val(dish,group,seat)===team2&&(team2List[team2List.length]=[dish,group,seat]);if(team1List.length!=ndishes||team2List.length!=ndishes)throw"WHOOPS! Team occurences not right";for(var i=0;ndishes>i;++i){var _team1List$i=_slicedToArray(team1List[i],3),_dish=_team1List$i[0],_group=_team1List$i[1],_seat=_team1List$i[2];val(_dish,_group,_seat,team2)}for(var _i2=0;ndishes>_i2;++_i2){var _team2List$_i=_slicedToArray(team2List[_i2],3),_dish2=_team2List$_i[0],_group2=_team2List$_i[1],_seat2=_team2List$_i[2];val(_dish2,_group2,_seat2,team1)}}var _ssProb=_slicedToArray(ssProb,2);rolls=_ssProb[0],chance=_ssProb[1];for(var _2=0;rolls>_2;++_2){{config.dishes}if(!(Math.random()>chance)){for(var _dish3=ndishes*Math.random()<<0,_seat3=ndishes*Math.random()<<0,group1=ngroups*Math.random()<<0,group2=ngroups*Math.random()<<0;group2==group1;)group2=ngroups*Math.random()<<0;var _team=val(_dish3,group1,_seat3),_team2=val(_dish3,group2,_seat3);val(_dish3,group1,_seat3,_team2),val(_dish3,group2,_seat3,_team)}}return match}function asLong(config,match){for(var nteams=config.nteams,ndishes=config.ndishes,ngroups=config.ngroups,val=cursor3d(match.data,match.nx,match.ny,match.nz),long=[],team=0;nteams>team;++team)long[team]=[-1,-1,-1,-1];for(var dish=0;ndishes>dish;++dish)for(var group=0;ngroups>group;++group){var cooking=val(dish,group,0);long[cooking][0]=dish;for(var seat=0;ndishes>seat;++seat){var _team3=val(dish,group,seat);long[_team3][dish+1]=cooking}}return long}function asList(config,match){for(var teams=config.teams,dishes=config.dishes,long=asLong(config,match),result=[],i=0;i<long.length;++i){var row={};row.teamId=teams[i].id,row.cooking=dishes[long[i][0]];for(var j=0;j<dishes.length;++j)-1!==long[i][j+1]&&(row[dishes[j]]=teams[long[i][j+1]].id);result[result.length]=row}return result}function asFull(config,match){for(var teams=config.teams,dishes=config.dishes,ndishes=config.ndishes,ngroups=config.ngroups,nteams=config.nteams,val=cursor3d(match.data,match.nx,match.ny,match.nz),long=asLong(config,match),result=[],i=0;nteams>i;++i){result[i]={teamId:teams[i].id,cooking:dishes[long[i][0]]};for(var j=0;ndishes>j;++j)result[i][dishes[j]]=[]}for(var dish=0;ndishes>dish;++dish)for(var group=0;ngroups>group;++group)for(var seatA=0;ndishes>seatA;++seatA)for(var dishName=dishes[dish],team=val(dish,group,seatA),seatB=0;ndishes>seatB;++seatB){var other=val(dish,group,seatB);result[team][dishName].push(teams[other].id)}return result}function matchPattern(text,what){var tokens=text.match(/\S+/g);if(null===tokens)return null;if(tokens.length!==what.length)return null;for(var values=[],i=0;i<what.length;++i)if("*"===what[i])values[values.length]=tokens[i];else if(what[i]!==tokens[i])return null;return values}function parseConstraints(text){for(var lines=text.split("\n"),errors=[],cns=[],i=0;i<lines.length;++i){var line=lines[i].trim();if(""!==line){var match=void 0;match=matchPattern(line,["teams","meet","once"]),match?cns[cns.length]={type:"onlyOnce",line:i+1}:(match=matchPattern(line,["ways","short"]),match?cns[cns.length]={type:"shortWays",line:i+1}:(match=matchPattern(line,["ways","similar"]),match?cns[cns.length]={type:"sameWays",line:i+1}:(match=matchPattern(line,["*","cooks","*"]),match?cns[cns.length]={type:"dish",teamId:match[0],dish:match[1],pos:!0,line:i+1}:(match=matchPattern(line,["*","not","cooks","*"]),match?cns[cns.length]={type:"dish",teamId:match[0],dish:match[1],pos:!1,line:i+1}:(match=matchPattern(line,["*","meets","*"]),match?cns[cns.length]={type:"pair",teamId1:match[0],teamId2:match[1],pos:!0,line:i+1}:(match=matchPattern(line,["*","not","meets","*"]),match?cns[cns.length]={type:"pair",teamId1:match[0],teamId2:match[1],pos:!1,line:i+1}:errors[errors.length]=[i+1,"unknown rule"]))))))}}return[errors,cns]}function checkConstraints(teams,dishes,cns){for(var errors=[],i=0;i<cns.length;++i){var cn=cns[i];if("dish"===cn.type){for(var found=!1,j=0;j<teams.length;++j)if(teams[j].id===cn.teamId){found=!0;break}found||(errors[errors.length]=[i,"did not find team "+cn.teamId]),found=!1;for(var _j2=0;_j2<dishes.length;++_j2)if(dishes[_j2]===cn.dish){found=!0;break}found||(errors[errors.length]=[i,"dish "+cn.dish+" does not exist"])}if("pair"===cn.type){cn.teamId1===cn.teamId2&&(errors[errors.length]=[i,"used the same team twice"]);for(var found1=!1,found2=!1,_j3=0;_j3<teams.length&&(teams[_j3].id===cn.teamId1&&(found1=!0),teams[_j3].id===cn.teamId2&&(found2=!0),!found1||!found2);++_j3);found1||(errors[errors.length]=[i,"did not find team "+cn.teamId1]),found2||(errors[errors.length]=[i,"did not find team "+cn.teamId2])}}return errors}function score(config,cns,match){for(var total=0,partials=[],long=asLong(config,match),i=0;i<cns.length;++i){var cn=cns[i];if(void 0===scoreFns[cn.type])throw"WHOOPS! Unknown constraint";var _score=scoreFns[cn.type](config,cn,match,long);total+=_score[0],partials[partials.length]=_score}return{total:total,partials:partials}}var scoreFns={};return scoreFns.onlyOnce=function(config,cn,match){for(var ndishes=config.ndishes,ngroups=config.ngroups,val=(config.nteams,cursor3d(match.data,match.nx,match.ny,match.nz)),weight=cn.weight||1e4,visited={},multiple=0,dish=0;ndishes>dish;++dish)for(var group=0;ngroups>group;++group){for(var guests=[],seatA=0;ndishes>seatA;++seatA){var team=val(dish,group,seatA);guests[guests.length]=team;for(var seatB=0;ndishes>seatB;++seatB)if(seatA!=seatB){var other=val(dish,group,seatB);void 0==visited[other]&&(visited[other]={}),void 0!==visited[other][team]&&(multiple+=1)}}for(var _seatA=0;ndishes>_seatA;++_seatA)for(var _team4=val(dish,group,_seatA),_seatB=0;ndishes>_seatB;++_seatB)if(_seatA!=_seatB){var _other=val(dish,group,_seatB);visited[_other][_team4]=!0}}return 0===multiple?[0,"ok","no teams meet more than once"]:[multiple*weight,"bad","teams have met multiple times"]},scoreFns.shortWays=function(config,cn,match,long){for(var teams=config.teams,ndishes=config.ndishes,score=(config.nteams,config.ngroups,cn.weight||2,0),i=0;i<long.length;++i)for(var j=1;ndishes>j;++j){var start=teams[long[i][j]],end=teams[long[i][j+1]];score+=calcCrow([start.lat,start.lng],[end.lat,end.lng])}return[score,"ok","based on total distance traveled"]},scoreFns.sameWays=function(config,cn,match,long){for(var ndishes=config.ndishes,weight=(config.nteams,config.ngroups,cn.weight||2),distances=[],sum=0,i=0;i<long.length;++i)for(var j=1;ndishes>j;++j){var start=teams[long[i][j]],end=teams[long[i][j+1]],dist=calcCrow([start.lat,start.lng],[end.lat,end.lng]);sum+=dist,distances[distances.length]=dist}var dev=(sum/distances.length,distances.reduce(function(a,b){return a+b})/distances.length),score=dev*weight;return[score,"ok",'based on "unfairness" of distances']},scoreFns.dish=function(config,cn,match,long){for(var dishes=config.dishes,teams=config.teams,weight=(config.ndishes,config.nteams,config.ngroups,cn.weight||100),dishName=cn.dish,teamId=cn.teamId,positive=cn.pos,dish=dishes.indexOf(dishName),team=-1,i=0;i<teams.length;++i)if(teams[i].id===teamId){team=i;break}var hasDish=long[team][0]===dish,ok=hasDish&&positive||!hasDish&&!positive;return ok?[0,"ok",""]:[weight,"bad","team "+teamId+" has unwanted dish"]},scoreFns.pair=function(){return[5,"bad","not implemented"]},{makeConfig:makeConfig,initialMatch:initialMatch,shuffleMatch:shuffleMatch,parseConstraints:parseConstraints,checkConstraints:checkConstraints,asList:asList,asLong:asLong,asFull:asFull,score:score}}(),workerMain=function(){function bestOf(config,match,rules,n){bestMatch=match,bestScore=matching.score(config,rules,match);for(var i=0;n>i;++i){var attempt=matching.shuffleMatch(config,match,[2,.125],[10,.2]),score=matching.score(config,rules,attempt);score.total<bestScore.total&&(bestMatch=attempt,bestScore=score),tried+=1}postMessage({action:"update",score:bestScore,match:bestMatch,tried:tried})}var config=void 0,bestMatch=void 0,bestScore=void 0,rules=void 0,n=void 0,tried=0;self.addEventListener("message",function(e){var msg=e.data;if("start"===msg.action){n=msg.n,rules=msg.rules,config=msg.config,tried=0;var match=(msg.imports,msg.match);postMessage({action:"started"}),bestOf(config,match,rules,n)}"continue"===msg.action&&bestOf(config,bestMatch,rules,n),"stop"===msg.action&&(postMessage({action:"stopped"}),close())},!1)};
workerMain()</script>
  </head>
  <body>
    <div id="header-row">
      <img src="logo.png">
      <h1>
        Running Dinner
      </h1>
      <div id="loading"></div>
      <div style="position: absolute; right: 1em; top: 1em;">
        <a href="datenschutz.html">Datenschutzerklärung</a>
      </div>
    </div>

    <div id="main-row">
      <div id="tabs" class="tabs">
      </div>
      <div id="tab-content">
      </div>
    </div>
    <div id="footer-row">
    </div>
  </body >
</html>
